# vulnerability_scanner.py
import time
from typing import List, Dict, Tuple

VULNERABILITY_PATTERNS = {
    "SQL_INJECTION": {"severity": "CRITICAL", "keywords": ["SELECT * FROM", "WHERE id =", "'+ user_input +'", "' + request.form"]},
    "CROSS_SITE_SCRIPTING": {"severity": "HIGH", "keywords": ["response.write(", "document.write("]},
    "INSECURE_DB_ACCESS": {"severity": "HIGH", "keywords": ["user='root'", "password='password'", "check_same_thread=False"]},
    "HARDCODED_CREDENTIALS": {"severity": "MEDIUM", "keywords": ["api_key = \"", "SECRET_KEY ="]}
}

class AIScanner:
    """Module for ethical vulnerability scanning."""
    
    def __init__(self, patterns=VULNERABILITY_PATTERNS):
        self.patterns = patterns

    def scan_code(self, code_base: List[str]) -> Dict[str, List[Tuple[int, str]]]:
        """Scans code for defined patterns."""
        vulnerability_report = {name: [] for name in self.patterns.keys()}
        
        for line_num, line in enumerate(code_base, 1):
            line_lower = line.lower()
            
            for vuln_name, details in self.patterns.items():
                if any(k.lower() in line_lower for k in details["keywords"]):
                    vulnerability_report[vuln_name].append((line_num, line.strip()))
                    
        return vulnerability_report

    def run_scan(self, code_base: List[str]):
        """Executes the scan and prints a user-friendly report."""
        start_time = time.time()
        report = self.scan_code(code_base)
        end_time = time.time()
        
        print(f"## âœ… Scan Completed in {round(end_time - start_time, 4)} seconds. (Simulating AI Speed)")
        print("\n### VULNERABILITY REPORT ###")
        
        for vuln_name, findings in report.items():
            if findings:
                details = self.patterns[vuln_name]
                print(f"ðŸš¨ **{details['severity']} FINDING: {vuln_name}**")
                for line_num, snippet in findings:
                    print(f"   Line {line_num}: `{snippet}`")
            else:
                print(f"âœ… {vuln_name}: Clean.")